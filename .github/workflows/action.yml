name: Java CI with Maven and Auto Merge

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
    
    - name: Build with Maven
      working-directory: ./lab4
      run: mvn -B compile
    
    - name: Run tests with Maven
      working-directory: ./lab4
      run: mvn -B test
      
  auto-merge:
    needs: test  # 等待 test 任务完成
    runs-on: ubuntu-latest
    if: success() && github.event_name == 'pull_request'
    
    steps:
    - name: Debug - Show context
      run: |
        echo "Event name: ${{ github.event_name }}"
        echo "PR number: ${{ github.event.pull_request.number }}"
        echo "Base ref: ${{ github.event.pull_request.base.ref }}"
        echo "Head ref: ${{ github.event.pull_request.head.ref }}"
    
    - name: Auto merge PR
      if: github.event.pull_request.head.ref == 'dev' && github.event.pull_request.base.ref == 'main'
      uses: actions/github-script@v7
      env:
        GITHUB_TOKEN: ${{ secrets.AUTO_MERGE_TOKEN }}
      with:
        script: |
          console.log(`Attempting to merge PR #${{ github.event.pull_request.number }}`);
          
          try {
            // 1. 批准 PR
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              event: 'APPROVE'
            });
            
            // 2. 合并 PR
            const result = await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              merge_method: 'squash',
              commit_title: `Auto-merge PR #${context.issue.number}`,
              commit_message: `This PR was automatically merged after passing all tests.\n\nCloses #${context.issue.number}`
            });
            
            console.log(`Successfully merged PR #${context.issue.number}`);
            console.log(`Merge SHA: ${result.data.sha}`);
          } catch (error) {
            console.error(`name: Java CI with Maven and Auto Merge

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
    
    - name: Build with Maven
      working-directory: ./lab4
      run: mvn -B compile
    
    - name: Run tests with Maven
      working-directory: ./lab4
      run: mvn -B test
      
  auto-merge:
    needs: test  # 等待 test 任务完成
    runs-on: ubuntu-latest
    if: success() && github.event_name == 'pull_request'
    
    steps:
    - name: Debug - Show context
      run: |
        echo "Event name: ${{ github.event_name }}"
        echo "PR number: ${{ github.event.pull_request.number }}"
        echo "Base ref: ${{ github.event.pull_request.base.ref }}"
        echo "Head ref: ${{ github.event.pull_request.head.ref }}"
    
    - name: Auto merge PR
      if: github.event.pull_request.head.ref == 'dev' && github.event.pull_request.base.ref == 'main'
      uses: actions/github-script@v7
      env:
        GITHUB_TOKEN: ${{ secrets.AUTO_MERGE_TOKEN }}
      with:
        script: |
          console.log(`Attempting to merge PR #${{ github.event.pull_request.number }}`);
          
          try {
            // 1. 批准 PR
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              event: 'APPROVE'
            });
            
            // 2. 合并 PR
            const result = await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              merge_method: 'squash',
              commit_title: `Auto-merge PR #${context.issue.number}`,
              commit_message: `This PR was automatically merged after passing all tests.\n\nCloses #${context.issue.number}`
            });
            
            console.log(`Successfully merged PR #${context.issue.number}`);
            console.log(`Merge SHA: ${result.data.sha}`);
          } catch (error) {
            console.error(`Failed to merge PR #${context.issue.number}:`, error.message);
            console.error('Error details:', error);
          }Failed to merge PR #${context.issue.number}:`, error.message);
            console.error('Error details:', error);
          }